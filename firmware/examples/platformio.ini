# ForgePCB PlatformIO Configuration Example
# Feature F005: Firmware tooling with PlatformIO integration
#
# This example shows how to use PlatformIO with ForgePCB's provenance tracking.
#
# Usage:
#   1. Copy this file to your PlatformIO project root
#   2. Adjust paths to match your setup
#   3. Build: pio run
#   4. Flash with provenance: pio run --target upload
#
# The custom upload commands call ForgePCB flash scripts, ensuring:
#   - Mandatory build ID (git commit)
#   - Provenance tracking
#   - Event logging
#   - Rail fault detection

# ==============================================================================
# Global Settings
# ==============================================================================
[platformio]
# Uncomment to set default environment
# default_envs = esp32s3

# ==============================================================================
# ESP32-S3 DevKit Carrier
# ==============================================================================
[env:esp32s3]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

# Serial monitor settings
monitor_speed = 115200
monitor_port = /dev/forgepcb-esp32s3

# Custom upload command (calls ForgePCB flash script with provenance)
upload_protocol = custom
upload_command = ${platformio.packages_dir}/../../../firmware/tools/flash_esp32.sh $SOURCE --build-id "$(git rev-parse --short HEAD) ($(git branch --show-current)@$(date -u +%Y-%m-%dT%H:%M:%SZ))" --port /dev/forgepcb-esp32s3

# Build flags
build_flags =
    -DCORE_DEBUG_LEVEL=3
    -DBOARD_HAS_PSRAM

# Dependencies (example)
lib_deps =
    # Add your libraries here

# ==============================================================================
# ESP32-S3 DevKit Carrier (Alternative: ESP-IDF Framework)
# ==============================================================================
[env:esp32s3-idf]
platform = espressif32
board = esp32-s3-devkitc-1
framework = espidf

monitor_speed = 115200
monitor_port = /dev/forgepcb-esp32s3

upload_protocol = custom
upload_command = ${platformio.packages_dir}/../../../firmware/tools/flash_esp32.sh $SOURCE --build-id "$(git rev-parse --short HEAD)" --port /dev/forgepcb-esp32s3

# ==============================================================================
# RP2040 Pico Carrier (Arduino Framework)
# ==============================================================================
[env:rp2040]
platform = raspberrypi
board = pico
framework = arduino

monitor_speed = 115200
monitor_port = /dev/forgepcb-rp2040

# Custom upload command (calls ForgePCB flash script)
# Note: RP2040 requires BOOTSEL mode (manual action, logged by script)
upload_protocol = custom
upload_command = ${platformio.packages_dir}/../../../firmware/tools/flash_rp2040.sh $SOURCE --build-id "$(git rev-parse --short HEAD) ($(git branch --show-current)@$(date -u +%Y-%m-%dT%H:%M:%SZ))"

# Build flags
build_flags =
    -DPICO_BOARD=pico

lib_deps =
    # Add your libraries here

# ==============================================================================
# RP2040 Pico Carrier (Pico SDK Framework)
# ==============================================================================
[env:rp2040-sdk]
platform = raspberrypi
board = pico
framework = arduino  # PlatformIO doesn't have native Pico SDK support yet

monitor_speed = 115200
monitor_port = /dev/forgepcb-rp2040

upload_protocol = custom
upload_command = ${platformio.packages_dir}/../../../firmware/tools/flash_rp2040.sh $SOURCE --build-id "$(git rev-parse --short HEAD)"

# ==============================================================================
# Development Environment (Fast Iteration)
# ==============================================================================
[env:esp32s3-dev]
extends = env:esp32s3

# Faster upload (lower baud, skip verification for speed)
upload_command = ${platformio.packages_dir}/../../../firmware/tools/flash_esp32.sh $SOURCE --build-id "$(git rev-parse --short HEAD)-dev" --port /dev/forgepcb-esp32s3 --baud 460800 --no-verify

# Debug build flags
build_flags =
    ${env:esp32s3.build_flags}
    -DDEBUG=1
    -DLOG_LEVEL=VERBOSE

# ==============================================================================
# Notes
# ==============================================================================
# 1. Build ID Generation:
#    - Short commit: $(git rev-parse --short HEAD)
#    - Full commit: $(git rev-parse HEAD)
#    - With branch + timestamp: $(git rev-parse --short HEAD) ($(git branch --show-current)@$(date -u +%Y-%m-%dT%H:%M:%SZ))
#
# 2. Upload Commands:
#    - PlatformIO calls ForgePCB flash scripts
#    - Provenance is automatically tracked
#    - Event logging happens in scripts
#
# 3. Serial Monitor:
#    - Use: pio device monitor
#    - Or use ForgePCB serial capture: firmware/tools/serial_capture.sh --target esp32s3
#    - ForgePCB serial capture has timestamping and provenance linking
#
# 4. RP2040 BOOTSEL Mode:
#    - flash_rp2040.sh will prompt for BOOTSEL mode
#    - Hold RUN button, press BOOTSEL, release RUN
#    - Script logs this as a manual action event
#
# 5. Troubleshooting:
#    - If upload_command fails, check path to flash scripts
#    - Ensure udev rules are installed: sudo cp firmware/configs/udev/99-forgepcb.rules /etc/udev/rules.d/
#    - Verify symlinks exist: ls -l /dev/forgepcb-*
